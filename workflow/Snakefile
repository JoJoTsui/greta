from snakemake.utils import min_version
min_version('7.29.0')
import sys
import os
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(os.path.curdir), 'workflow', 'scripts', 'analysis')))
from utils import make_combs
from itertools import combinations
home_path = os.path.expanduser("~")


def map_rules(rule_prefix, w_name, out='out'):
    rule_name=f'{rule_prefix}_{w_name}'
    if hasattr(rules, rule_name):
        return getattr(rules, rule_name).output[out]
    else:
        print(f'rule_prefix={rule_prefix} w_name={w_name}, out={out}, rule_name={rule_name}')


def format_rule(out, w, pre, p2g=None, tfb=None, mdl=None, resource=None):
    if (p2g is None) & (tfb is None) & (mdl is None):
        p2g, tfb, mdl = pre, pre, pre
    frm = out.format(
        pre=pre,
        p2g=p2g,
        tfb=tfb,
        mdl=mdl,
        **w
    )
    return frm


def make_combs_rules(w, mthds, baselines, rule_name):
    from itertools import product
    out = getattr(rules, rule_name).output.out
    rule_outputs = []
    mthds = [m for m in mthds if m != 'scenicplus']
    if w.dataset not in nocombs_datasets:
        for pre, p2g, tfb, mdl in product(mthds, repeat=4):
            rule_outputs.append(
                format_rule(out, w=w, pre=pre, p2g=p2g, tfb=tfb, mdl=mdl)
            )
    else:
        for mth in mthds:
            rule_outputs.append(format_rule(out, w=w, pre=mth))
    for mth in mthds:
        if mth != 'scenicplus':  # TODO: remove once src scenic
            rule_outputs.append(format_rule(out, w=w, pre='o_' + mth))
    for bsl in baselines:
        rule_outputs.append(format_rule(out, w=w, pre=bsl))
    return rule_outputs


def list_frags_files(wildcards):
    return expand('datasets/{dataset}/{sample}.frags.tsv.gz',
                    dataset=wildcards.dataset,
                    sample=config['datasets'][wildcards.dataset]['samples'])


def restart_mem(wildcards, attempt):
    return (2 ** (4 + attempt)) * 1000


configfile: 'config/config.yaml'

mthds = list(config['methods'].keys())
baselines = config['baselines']

datasets = list(config['datasets'].keys())
stab_datasets = config['stab_datasets']
nocombs_datasets = config['nocombs_datasets']

# Datasets
include: 'rules/datasets/pbmc10k.smk'
include: 'rules/datasets/reprofibro.smk'
include: 'rules/datasets/pitupair.smk'
include: 'rules/datasets/pitunpair.smk'
include: 'rules/datasets/fakepair.smk'
include: 'rules/datasets/heartatlas.smk'
include: 'rules/datasets/brain.smk'
include: 'rules/datasets/general.smk'

# Methods
include: 'rules/methods/celloracle.smk'
include: 'rules/methods/dictys.smk'
include: 'rules/methods/pando.smk'
include: 'rules/methods/granie.smk'
include: 'rules/methods/figr.smk'
include: 'rules/methods/hummus.smk'
include: 'rules/methods/scenicplus.smk'
include: 'rules/methods/grn.smk'
include: 'rules/methods/random.smk'
include: 'rules/methods/scenic.smk'

# Databases
include: 'rules/dbs/ont.smk'
include: 'rules/dbs/tfm.smk'
include: 'rules/dbs/tfb.smk'
include: 'rules/dbs/cre.smk'

# Analyses
include: 'rules/analysis/metrics/prior.smk'
include: 'rules/analysis/metrics/pred.smk'
include: 'rules/analysis/metrics/mech.smk'
include: 'rules/analysis/metrics/utils.smk'
include: 'rules/analysis/stab.smk'
include: 'rules/analysis/topo.smk'
include: 'rules/analysis/pair.smk'
include: 'rules/analysis/tss.smk'

rule all:
    input:
        ''

# snakemake --profile config/slurm/ --notemp ...
